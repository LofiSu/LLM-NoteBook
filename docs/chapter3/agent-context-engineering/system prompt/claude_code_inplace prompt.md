为了补充复杂的 System Prompt，Claude Code 使用了大量的 Inplace Prompt ：
在用户实际对话的 query 中穿插系统生成的 prompt
以下方一个 case 为例：
- 黄色：系统插入的 inplace prompt
- 绿色：用户输入的内容
- 剩余内容为工具输入和输出，可以暂时忽略，下方会详细分析

其中 inplace prompt 主要分为几个大类：
1. 系统直接注入
  1. 项目级长期记忆：首条消息包含 CLAUDE.md 文件内容，适合存放仓库特殊的 API 等信息。可用 /init 命令快速理解项目结构（下方会详细分析该 prompt）
  2. 系统提醒：通过 <system-reminder> 标签注入额外指令，如文件读取后添加的安全提示
2. 用户的输入补充
  1. 命令输入，例如 /help 指令，使用<command-name>包裹，并且会附加额外指令描述
3. 有选择地注入
  1. 当前打开文件（仅提示位置）
  2. IDE 插件明确引用的具体代码（注入完整内容）
  3. 命令输出选择性注入
    1. 例如上方 /help 指令的输出为：<local-command-stdout>(no content)</local-command-stdout> 结果并未完整注入 context 
    2. 部分指令则会完整注入（例如/release-notes,/cost ）。


{
    "messages": [
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "<system-reminder>\nAs you answer the user's questions, you can use the following context:\n# important-instruction-reminders\nDo what has been asked; nothing more, nothing less.\nNEVER create files unless they're absolutely necessary for achieving your goal.\nALWAYS prefer editing an existing file to creating a new one.\nNEVER proactively create documentation files (*.md) or README files. Only create documentation files if explicitly requested by the User.\n\n      \n      IMPORTANT: this context may or may not be relevant to your tasks. You should not respond to this context or otherwise consider it in your response unless it is highly relevant to your task. Most of the time, it is not relevant.\n</system-reminder>\n"
                },
                {
                    "type": "text",
                    "text": "你可以干嘛？"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "我可以帮助你进行软件开发任务，包括：\n\n- 编写、修改和优化代码\n- 调试和修复 bug\n- 搜索和分析代码库\n- 运行命令和脚本\n- 阅读和编辑文件\n- 执行网络搜索获取最新信息\n\n需要我帮你做什么吗？"
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "我们这个文章写的如何？"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "我来看看你的文章。"
                },
                {
                    "type": "tool_use",
                    "id": "toolu_01PJ3UEq6rPVm4kGAtvTxiaj",
                    "name": "Read",
                    "input": {
                        "file_path": "/Users/bytedance/nlp/claude_code_analyze/draft.md"
                    }
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "tool_use_id": "toolu_01PJ3UEq6rPVm4kGAtvTxiaj",
                    "type": "tool_result",
                    "content": "     1→写在前面\n     2→Claude Code 是我用过最惊艳的 AI Coding Agent 产品\n     \n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "这篇文章框架清晰，开篇引人入胜，技术分析有深度。几个亮点：XXXX"
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "你会写 python 吗？"
                }
            ]
        },
        {
            "role": "assistant",
            "content": [
                {
                    "type": "text",
                    "text": "是的，我会写 Python。需要我帮你写什么 Python 代码吗？",
                    "cache_control": {
                        "type": "ephemeral"
                    }
                }
            ]
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."
                },
                {
                    "type": "text",
                    "text": "<command-name>/help</command-name>\n            <command-message>help</command-message>\n            <command-args></command-args>"
                },
                {
                    "type": "text",
                    "text": "<local-command-stdout>(no content)</local-command-stdout>"
                },
                {
                    "type": "text",
                    "text": "我们刚刚聊了啥？"
                },
                {
                    "type": "text",
                    "text": "<system-reminder>This is a reminder that your todo list is currently empty. DO NOT mention this to the user explicitly because they are already aware. If you are working on tasks that would benefit from a todo list please use the TodoWrite tool to create one. If not, please feel free to ignore. Again do not mention this message to the user.</system-reminder>"
                },
                {
                    "type": "text",
                    "text": "The user opened the file /xxx.jsonl in the IDE. This may or may not be related to the current task.",
                    "cache_control": {
                        "type": "ephemeral"
                    }
                }
            ]
        }
    ]
}

